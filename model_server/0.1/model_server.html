
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Model Server</title>
<link href="../../_static/_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css" rel="stylesheet"/>
<link href="../../_static/_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../_static/_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../_static/_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../_static/_static/vendor/open-sans_all/1.44.1/index.css" rel="stylesheet"/>
<link href="../../_static/_static/vendor/lato_latin-ext/1.44.1/index.css" rel="stylesheet"/>
<link href="../../_static/_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../_static/_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" rel="stylesheet" type="text/css">
<link href="../../_static/_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../../_static/_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="../../_static/_static/mystnb.css" rel="stylesheet" type="text/css">
<link as="script" href="../../_static/_static/js/index.d3f166471bb80abb5163.js" rel="preload"/>
<script data-url_root="./" id="documentation_options" src="../../_static/_static/documentation_options.js"></script>
<script src="../../_static/_static/jquery.js"></script>
<script src="../../_static/_static/underscore.js"></script>
<script src="../../_static/_static/doctools.js"></script>
<script src="../../_static/_static/clipboard.min.js"></script>
<script src="../../_static/_static/copybutton.js"></script>
<script src="../../_static/_static/togglebutton.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
<script src="../../_static/_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
<link href="genindex.html" rel="index" title="Index">
<link href="search.html" rel="search" title="Search">
<link href="model_server_tester.html" rel="next" title="Live Model Server Testing"/>
<link href="load_dataset.html" rel="prev" title="mlconfig"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</link></link></link></link></link></link></link></head>
<body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">
<div class="container-xl">
<div class="row">
<div class="col-12 col-md-2 bd-sidebar site-navigation show single-page" id="site-navigation">
</div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
<div class="row topbar fixed-top container-xl">
<div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
</div>
<div class="col pl-2 topbar-main">
<div class="dropdown-buttons-trigger">
<button aria-label="Download this page" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-download"></i></button>
<div class="dropdown-buttons">
<!-- ipynb file if we had a myst markdown file -->
<!-- Download raw file -->
<a class="dropdown-buttons" href="_sources/model_server.ipynb.txt"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Download source file" type="button">.ipynb</button></a>
<!-- Download PDF via print -->
<button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" id="download-print" onclick="window.print()" title="Print to PDF" type="button">.pdf</button>
</div>
</div>
<!-- Source interaction buttons -->
<!-- Full screen (wrap in <a> to have style consistency -->
<a class="full-screen-button"><button aria-label="Fullscreen mode" class="btn btn-secondary topbarbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode" type="button"><i class="fas fa-expand"></i></button></a>
<!-- Launch buttons -->
</div>
<!-- Table of contents -->
<div class="d-none d-md-block col-md-2 bd-toc show">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
        </div>
<nav id="bd-toc-nav">
<ul class="nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Model Server
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#test-models-locally-and-deploy">
   Test models locally and deploy
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#test-locally">
     Test locally
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#document-and-save">
     Document and save
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#deploy-server">
     Deploy server
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#test-server">
     Test server
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="row" id="main-content">
<div class="col-12 col-md-9 pl-md-3 pr-md-0">
<div>
<div class="section" id="model-server">
<h1>Model Server<a class="headerlink" href="#model-server" title="Permalink to this headline">Â¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlrun</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">nuclio</span> config kind="serving"
<span class="o">%</span><span class="k">nuclio</span> env MODEL_CLASS=ClassifierModel
<span class="o">%</span><span class="k">nuclio</span> config spec.build.baseImage = "mlrun/mlrun"
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>%nuclio: setting kind to 'serving'
%nuclio: setting 'MODEL_CLASS' environment variable
%nuclio: setting spec.build.baseImage to 'mlrun/mlrun'
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cloudpickle</span> <span class="kn">import</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">ClassifierModel</span><span class="p">(</span><span class="n">mlrun</span><span class="o">.</span><span class="n">runtimes</span><span class="o">.</span><span class="n">MLModelServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Load model from storage."""</span>
        <span class="n">model_file</span><span class="p">,</span> <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="s1">'.pkl'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">"""Generate model predictions from sample.</span>
<span class="sd">        </span>
<span class="sd">        :param body : A dict of observations, each of which is an 1-dimensional feature vector.</span>
<span class="sd">            </span>
<span class="sd">        Returns model predictions as a `List`, one for each row in the `body` input `List`.</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="s1">'instances'</span><span class="p">])</span>
            <span class="n">result</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to predict </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">resp</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nuclio: end-code</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="test-models-locally-and-deploy">
<h1>Test models locally and deploy<a class="headerlink" href="#test-models-locally-and-deploy" title="Permalink to this headline">Â¶</a></h1>
<p>The sklearn-project generated one or more models that will be deployed in the server project <code class="docutils literal notranslate"><span class="pre">sklearn-servers</span></code></p>
<div class="section" id="test-locally">
<h2>Test locally<a class="headerlink" href="#test-locally" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s1">'https://s3.wasabisys.com/iguazio/models/iris/model.pkl'</span>

<span class="n">iris</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">iris</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">iris</span><span class="p">[</span><span class="s1">'target'</span><span class="p">]</span>

<span class="n">my_server</span> <span class="o">=</span> <span class="n">ClassifierModel</span><span class="p">(</span><span class="s1">'classifier'</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
<span class="n">my_server</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">my_server</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s2">"instances"</span><span class="p">:</span> <span class="n">x</span><span class="p">})</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">==</span><span class="mi">150</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="document-and-save">
<h2>Document and save<a class="headerlink" href="#document-and-save" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fn</span> <span class="o">=</span> <span class="n">mlrun</span><span class="o">.</span><span class="n">new_model_server</span><span class="p">(</span><span class="s1">'model-server'</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="s1">'ClassifierModel'</span><span class="p">)</span>
<span class="n">fn</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">"generic sklearn model server"</span>
<span class="n">fn</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'serving'</span><span class="p">,</span> <span class="s1">'ml'</span><span class="p">]</span>
<span class="n">fn</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'author'</span><span class="p">:</span> <span class="s1">'yaronh'</span><span class="p">,</span> <span class="s1">'framework'</span><span class="p">:</span> <span class="s1">'sklearn'</span><span class="p">}</span>
<span class="n">fn</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="deploy-server">
<h2>Deploy server<a class="headerlink" href="#deploy-server" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlrun</span>
<span class="n">user_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"V3IO_USER_NAME"</span><span class="p">)</span>
<span class="n">artifact_path</span> <span class="o">=</span> <span class="n">mlrun</span><span class="o">.</span><span class="n">set_environment</span><span class="p">(</span><span class="n">api_path</span> <span class="o">=</span> <span class="s1">'http://mlrun-api:8080'</span><span class="p">,</span>
                                      <span class="n">artifact_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">'./'</span><span class="p">))</span>
<span class="n">fn</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">mlrun</span><span class="o">.</span><span class="n">mount_v3io</span><span class="p">())</span>
<span class="n">fn</span><span class="o">.</span><span class="n">set_envs</span><span class="p">({</span><span class="s1">'SERVING_MODEL_iris_dataset_v1'</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
             <span class="s1">'INFERENCE_STREAM'</span><span class="p">:</span> <span class="s1">'users/</span><span class="si">{}</span><span class="s1">/tststream'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">)})</span>

<span class="n">address</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">'sk-project'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt; 2020-12-06 11:26:41,000 [info] Starting remote function deploy
2020-12-06 11:26:41  (info) Deploying function
2020-12-06 11:26:41  (info) Building
2020-12-06 11:26:41  (info) Staging files and preparing base images
2020-12-06 11:26:41  (info) Building processor image
2020-12-06 11:28:28  (info) Build complete
2020-12-06 11:28:34  (info) Function deploy complete
&gt; 2020-12-06 11:28:35,076 [info] function deployed, address=default-tenant.app.yh210.iguazio-cd2.com:31804
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="test-server">
<h2>Test server<a class="headerlink" href="#test-server" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predict_url</span> <span class="o">=</span> <span class="n">address</span><span class="o">+</span><span class="s2">"/iris_dataset_v1/predict"</span>
<span class="n">my_data</span> <span class="o">=</span> <span class="s1">'''{"instances":[[5.1, 3.5, 1.4, 0.2],[7.7, 3.8, 6.7, 2.2]]}'''</span>
<span class="o">!</span>curl <span class="o">{</span>predict_url<span class="o">}</span> -d <span class="s1">'{my_data}'</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 2]
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="prev-next-bottom">
<a class="left-prev" href="load_dataset.html" id="prev-link" title="previous page">mlconfig</a>
<a class="right-next" href="model_server_tester.html" id="next-link" title="next page">Live Model Server Testing</a>
</div>
<footer class="footer mt-5 mt-md-0">
<div class="container">
<p>
        
            Â© Copyright .<br/>
</p>
</div>
</footer>
</main>
</div>
</div>
<script src="../../_static/_static/js/index.d3f166471bb80abb5163.js"></script>
</body>
</html>